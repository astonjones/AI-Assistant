# Architecture Overview - Post Cleanup

## System Architecture Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     External Services                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚  OpenAI  â”‚      â”‚  Twilio  â”‚      â”‚  Google  â”‚              â”‚
â”‚  â”‚ (Agent)  â”‚      â”‚(SMS/Voice)      â”‚(Gmail/Cal)               â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                  â”‚                  â”‚
        â”‚                  â”‚                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Your AI Agent                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              Express Server (index.js)                 â”‚  â”‚
â”‚  â”‚                                                        â”‚  â”‚
â”‚  â”‚  HTTP Server + WebSocket Server on port 3000         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚        â”‚                                          â”‚         â”‚
â”‚        â–¼                                          â–¼         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚HTTP Routes  â”‚                           â”‚  WebSocket  â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                           â”‚   Server    â”‚ â”‚
â”‚  â”‚ /agent      â”‚                           â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”‚ /auth       â”‚                                  â”‚        â”‚
â”‚  â”‚ /health     â”‚                          /voice/stream  â”‚
â”‚  â”‚ /sms/*      â”‚                                  â”‚        â”‚
â”‚  â”‚ /voice/... â”‚                                  â”‚        â”‚
â”‚  â”‚ /webhooks   â”‚                                  â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                  â”‚        â”‚
â”‚         â”‚                                         â”‚        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚              Router Layer                      â”‚       â”‚â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚       â”‚â”‚
â”‚  â”‚ â”‚ Agent    â”‚  â”‚ SMS      â”‚  â”‚ Voice        â”‚  â”‚       â”‚â”‚
â”‚  â”‚ â”‚ Router   â”‚  â”‚ Router   â”‚  â”‚ Router       â”‚  â”‚       â”‚â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚       â”‚â”‚
â”‚  â”‚      â”‚             â”‚             â”‚            â”‚       â”‚â”‚
â”‚  â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚â”‚
â”‚  â”‚                    â”‚                                  â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                       â–¼                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚           Service Layer (services/)                â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚                                                    â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚     TwilioService (twilio.js)                â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€ sendSMS()                                â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€ listMessages()                           â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€ getMessageDetails()                      â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€ initializeStream()                       â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€ handleAudioData()                        â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€ closeStream()                            â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€ getStreamStats()                         â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  Emits: stream-started, audio-received,      â”‚ â”‚  â”‚
â”‚  â”‚  â”‚         stream-ended                         â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚                                                    â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚     OpenAI Service (openai.js)               â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€ chat() - Send prompts, get responses    â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€ Handles tool calling                    â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚                                                    â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚     Email Service (email.js)                 â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€ sendEmail()                             â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€ getRecentEmails()                       â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€ Uses Gmail API                          â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚                                                    â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚     Calendar Service (calendar.js)           â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€ listEvents()                            â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€ createEvent()                           â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€ updateEvent()                           â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€ deleteEvent()                           â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚                                                    â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚     Function Handler (functionHandler.js)    â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€ Maps function names to handlers         â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€ executeFunction()                       â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€ Enables AI tool calling                 â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚                                                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Data Flow - SMS vs Voice

### SMS Flow (HTTP)

```
Client Request
    â”‚
    â–¼
POST /sms/send
    â”‚
    â–¼
SMS Route Handler
    â”‚
    â–¼
TwilioService.sendSMS()
    â”‚
    â–¼
Twilio API
    â”‚
    â–¼
SMS Sent âœ“
    â”‚
    â–¼
JSON Response
    â”‚
    â–¼
Connection Closes
```

**Duration:** ~200ms (one-time)

### Voice Flow (WebSocket)

```
Phone Call â†’ Twilio Network
    â”‚
    â–¼
POST /voice/incoming (HTTP)
    â”‚
    â–¼
Voice Route Handler
    â”‚
    â–¼
Generate TwiML Response
    â”‚
    â–¼
Twilio Receives Instructions
    â”‚
    â–¼
WebSocket Upgrade Request
    â”‚
    â–¼
WS /voice/stream Connection Opens
    â”‚
    â”œâ”€â†’ Event: "start"
    â”‚   â””â”€â†’ TwilioService.initializeStream()
    â”‚
    â”œâ”€â†’ Event: "media" (chunk 1)
    â”‚   â””â”€â†’ TwilioService.handleAudioData()
    â”‚
    â”œâ”€â†’ Event: "media" (chunk 2)
    â”‚   â””â”€â†’ TwilioService.handleAudioData()
    â”‚
    â”œâ”€â†’ ... (continuous audio chunks) ...
    â”‚
    â”œâ”€â†’ Event: "stop"
    â”‚   â””â”€â†’ TwilioService.closeStream()
    â”‚
    â–¼
Connection Closes
```

**Duration:** 0-3600 seconds (entire call)

## Request/Response Examples

### SMS Send Request
```json
POST /sms/send
Content-Type: application/json

{
  "to": "+15551234567",
  "body": "Hello from AI Agent"
}

Response:
{
  "success": true,
  "messageSid": "SM1234567890abcdef",
  "status": "queued",
  "message": "SMS sent to +15551234567"
}
```

### Voice Stats Request
```
GET /voice/stats

Response:
{
  "activeStreamCount": 1,
  "totalDuration": 45230,
  "totalAudioChunks": 152,
  "totalBytes": 614400,
  "streams": [
    {
      "callSid": "CA1234567890abcdef",
      "duration": "45.23",
      "audioChunks": 152,
      "bytes": 614400
    }
  ]
}
```

### Agent Request (with SMS)
```json
PUT /agent
Content-Type: application/json

{
  "prompt": "Send a text to 555-1234 saying hello",
  "tools": ["twilio"]
}

Response:
{
  "choices": [{
    "message": {
      "content": "I've sent the SMS to +15551234567 saying hello."
    }
  }],
  "toolCalls": [{
    "name": "send_sms",
    "content": "{\"success\": true, \"messageSid\": \"SM...\"}"
  }]
}
```

## Integration Points

### AI Agent Integrations
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   User Prompt       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  AI Agent    â”‚ â† Receives prompt
    â”‚  (/agent)    â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
     â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â–¼                        â–¼              â–¼
   Email                    SMS             Voice
   /agent                   /agent          (incoming)
                                           + webhook
     â”‚                        â”‚              â”‚
     â–¼                        â–¼              â–¼
EmailService          TwilioService      WebSocket
sendEmail()            sendSMS()          initializeStream()
getRecentEmails()      listMessages()     handleAudioData()
```

## Phase Roadmap

### âœ… Phase 1: Voice Streaming (Complete)
- Voice call reception
- Audio WebSocket
- Audio data capture
- Statistics tracking

### ğŸ”„ Phase 2: Audio Transcription (Next)
```
Voice Stream
    â†“
Whisper AI Transcription
    â†“
Text Output
    â†“
Ready for OpenAI processing
```

### ğŸ”„ Phase 3: AI Processing
```
Transcribed Text
    â†“
OpenAI Chat
    â†“
AI Response
    â†“
Ready for TTS
```

### ğŸ”„ Phase 4: Text-to-Speech
```
AI Response
    â†“
Text-to-Speech Conversion
    â†“
Audio Output
    â†“
Stream to Caller
```

## Summary

âœ… **HTTP Routes** - REST APIs for discrete operations (SMS)
âœ… **WebSocket** - Real-time bidirectional streaming (Voice)
âœ… **TwilioService** - Unified Twilio operations
âœ… **TwiML** - Call handling instructions
âœ… **EventEmitter** - Event-driven architecture
âœ… **Modular Design** - Easy to extend with Phase 2

**Ready for production and Phase 2! ğŸš€**
